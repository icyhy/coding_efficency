<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>认证修复测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
    }
    button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 10px 15px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
    }
    pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .error {
      color: red;
    }
    .success {
      color: green;
    }
  </style>
</head>
<body>
  <h1>认证修复测试</h1>
  
  <div class="card">
    <h2>登录测试</h2>
    <div>
      <label for="username">用户名:</label>
      <input type="text" id="username" value="admin">
    </div>
    <div>
      <label for="password">密码:</label>
      <input type="password" id="password" value="admin123">
    </div>
    <button id="loginBtn">登录</button>
    <div id="loginResult"></div>
  </div>

  <div class="card">
    <h2>获取用户信息</h2>
    <button id="getUserInfoBtn">获取用户信息</button>
    <div id="userInfoResult"></div>
  </div>

  <div class="card">
    <h2>刷新Token</h2>
    <button id="refreshTokenBtn">刷新Token</button>
    <div id="refreshResult"></div>
  </div>

  <div class="card">
    <h2>登出</h2>
    <button id="logoutBtn">登出</button>
    <div id="logoutResult"></div>
  </div>

  <div class="card">
    <h2>Cookie状态</h2>
    <button id="checkCookiesBtn">检查Cookies</button>
    <div id="cookiesResult"></div>
  </div>

  <script>
    // API基础URL
    const API_BASE_URL = 'http://localhost:5000/api';
    
    // Cookie名称
    const TOKEN_KEY = 'coding_efficiency_token';
    const REFRESH_TOKEN_KEY = 'coding_efficiency_refresh_token';
    
    // 获取Cookie
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }
    
    // 设置Cookie
    function setCookie(name, value, days) {
      let expires = '';
      if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = `; expires=${date.toUTCString()}`;
      }
      document.cookie = `${name}=${value}${expires}; path=/`;
    }
    
    // 删除Cookie
    function deleteCookie(name) {
      document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
    }
    
    // 发送API请求
    async function apiRequest(endpoint, method = 'GET', data = null) {
      const url = `${API_BASE_URL}${endpoint}`;
      const token = getCookie(TOKEN_KEY);
      
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include'
      };
      
      if (token) {
        options.headers['Authorization'] = `Bearer ${token}`;
      }
      
      if (data) {
        options.body = JSON.stringify(data);
      }
      
      const response = await fetch(url, options);
      const responseData = await response.json();
      
      if (!response.ok) {
        throw new Error(responseData.message || '请求失败');
      }
      
      return responseData;
    }
    
    // 登录
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const resultElement = document.getElementById('loginResult');
      
      try {
        resultElement.innerHTML = '登录中...';
        const response = await apiRequest('/auth/login', 'POST', { username, password });
        
        // 保存token到cookie
        setCookie(TOKEN_KEY, response.data.access_token, 1/48); // 30分钟
        setCookie(REFRESH_TOKEN_KEY, response.data.refresh_token, 7); // 7天
        
        resultElement.innerHTML = `<pre class="success">${JSON.stringify(response, null, 2)}</pre>`;
        checkCookies();
      } catch (error) {
        resultElement.innerHTML = `<pre class="error">登录失败: ${error.message}</pre>`;
      }
    });
    
    // 获取用户信息
    document.getElementById('getUserInfoBtn').addEventListener('click', async () => {
      const resultElement = document.getElementById('userInfoResult');
      
      try {
        resultElement.innerHTML = '获取用户信息中...';
        const response = await apiRequest('/auth/profile');
        resultElement.innerHTML = `<pre class="success">${JSON.stringify(response, null, 2)}</pre>`;
      } catch (error) {
        resultElement.innerHTML = `<pre class="error">获取用户信息失败: ${error.message}</pre>`;
      }
    });
    
    // 刷新Token
    document.getElementById('refreshTokenBtn').addEventListener('click', async () => {
      const resultElement = document.getElementById('refreshResult');
      const refreshToken = getCookie(REFRESH_TOKEN_KEY);
      
      try {
        if (!refreshToken) {
          throw new Error('Refresh Token不存在');
        }
        
        resultElement.innerHTML = '刷新Token中...';
        const response = await fetch(`${API_BASE_URL}/auth/refresh`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${refreshToken}`
          },
          credentials: 'include'
        });
        
        const responseData = await response.json();
        
        if (!response.ok) {
          throw new Error(responseData.message || '刷新Token失败');
        }
        
        // 更新access token
        setCookie(TOKEN_KEY, responseData.data.access_token, 1/48); // 30分钟
        
        resultElement.innerHTML = `<pre class="success">${JSON.stringify(responseData, null, 2)}</pre>`;
        checkCookies();
      } catch (error) {
        resultElement.innerHTML = `<pre class="error">刷新Token失败: ${error.message}</pre>`;
      }
    });
    
    // 登出
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      const resultElement = document.getElementById('logoutResult');
      
      try {
        resultElement.innerHTML = '登出中...';
        const response = await apiRequest('/auth/logout', 'POST');
        
        // 清除cookies
        deleteCookie(TOKEN_KEY);
        deleteCookie(REFRESH_TOKEN_KEY);
        
        resultElement.innerHTML = `<pre class="success">${JSON.stringify(response, null, 2)}</pre>`;
        checkCookies();
      } catch (error) {
        resultElement.innerHTML = `<pre class="error">登出失败: ${error.message}</pre>`;
        
        // 即使API请求失败，也清除本地cookies
        deleteCookie(TOKEN_KEY);
        deleteCookie(REFRESH_TOKEN_KEY);
        checkCookies();
      }
    });
    
    // 检查Cookies
    function checkCookies() {
      const resultElement = document.getElementById('cookiesResult');
      const token = getCookie(TOKEN_KEY);
      const refreshToken = getCookie(REFRESH_TOKEN_KEY);
      
      let html = '<h3>当前Cookie状态:</h3>';
      html += `<p>Access Token: ${token ? '<span class="success">存在</span>' : '<span class="error">不存在</span>'}</p>`;
      html += `<p>Refresh Token: ${refreshToken ? '<span class="success">存在</span>' : '<span class="error">不存在</span>'}</p>`;
      
      resultElement.innerHTML = html;
    }
    
    document.getElementById('checkCookiesBtn').addEventListener('click', checkCookies);
    
    // 页面加载时检查cookies
    checkCookies();
  </script>
</body>
</html>