<!DOCTYPE html>
<html>
<head>
    <title>Cookie调试工具</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .cookie-item { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .cookie-name { font-weight: bold; color: #333; }
        .cookie-value { color: #666; word-break: break-all; }
        .highlight { background-color: #ffff99; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Cookie调试工具</h1>
    
    <div>
        <button onclick="showAllCookies()">显示所有Cookie</button>
        <button onclick="checkAuthTokens()">检查认证Token</button>
        <button onclick="clearAuthCookies()">清除认证Cookie</button>
        <button onclick="testRefreshToken()">测试Refresh Token API</button>
    </div>
    
    <div id="output"></div>
    
    <script>
        function showAllCookies() {
            const output = document.getElementById('output');
            const cookies = document.cookie.split(';');
            
            let html = '<h2>所有Cookie:</h2>';
            
            if (cookies.length === 1 && cookies[0] === '') {
                html += '<p>没有找到任何Cookie</p>';
            } else {
                cookies.forEach(cookie => {
                    const [name, value] = cookie.trim().split('=');
                    html += `<div class="cookie-item">`;
                    html += `<div class="cookie-name">${name}</div>`;
                    html += `<div class="cookie-value">${value || '(空值)'}</div>`;
                    html += `</div>`;
                });
            }
            
            output.innerHTML = html;
        }
        
        function checkAuthTokens() {
            const output = document.getElementById('output');
            
            // 检查特定的认证相关Cookie
            const accessToken = getCookie('coding_efficiency_token');
            const refreshToken = getCookie('coding_efficiency_refresh_token');
            
            let html = '<h2>认证Token检查:</h2>';
            
            html += `<div class="cookie-item ${accessToken ? 'highlight' : ''}">`;
            html += `<div class="cookie-name">Access Token (coding_efficiency_token)</div>`;
            html += `<div class="cookie-value">${accessToken || '未找到'}</div>`;
            html += `</div>`;
            
            html += `<div class="cookie-item ${refreshToken ? 'highlight' : ''}">`;
            html += `<div class="cookie-name">Refresh Token (coding_efficiency_refresh_token)</div>`;
            html += `<div class="cookie-value">${refreshToken || '未找到'}</div>`;
            html += `</div>`;
            
            // 检查localStorage
            const localStorageToken = localStorage.getItem('coding_efficiency_token');
            html += `<div class="cookie-item">`;
            html += `<div class="cookie-name">LocalStorage Token</div>`;
            html += `<div class="cookie-value">${localStorageToken || '未找到'}</div>`;
            html += `</div>`;
            
            output.innerHTML = html;
        }
        
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        function clearAuthCookies() {
            // 清除认证相关的Cookie
            document.cookie = 'coding_efficiency_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'coding_efficiency_refresh_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            
            // 清除localStorage
            localStorage.removeItem('coding_efficiency_token');
            
            alert('认证Cookie已清除');
            checkAuthTokens();
        }
        
        async function testRefreshToken() {
            const output = document.getElementById('output');
            const refreshToken = getCookie('coding_efficiency_refresh_token');
            
            if (!refreshToken) {
                output.innerHTML = '<h2>测试结果:</h2><p style="color: red;">未找到Refresh Token</p>';
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5001/api/auth/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${refreshToken}`
                    }
                });
                
                const result = await response.json();
                
                let html = '<h2>Refresh Token测试结果:</h2>';
                html += `<p>状态码: ${response.status}</p>`;
                html += `<p>响应: <pre>${JSON.stringify(result, null, 2)}</pre></p>`;
                
                output.innerHTML = html;
            } catch (error) {
                output.innerHTML = `<h2>测试结果:</h2><p style="color: red;">请求失败: ${error.message}</p>`;
            }
        }
        
        // 页面加载时自动检查
        window.onload = function() {
            checkAuthTokens();
        };
    </script>
</body>
</html>